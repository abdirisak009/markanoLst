# Deploy to VPS when pushing to main
# Push to https://github.com/abdirisak009/markanoLst → auto-deploy to VPS
# Uses SSH key: private key in GitHub Secrets (SSH_PRIVATE_KEY), public key on server (authorized_keys)
#
# Required secrets: SSH_HOST, SSH_USER, SSH_PRIVATE_KEY
# Optional: SSH_PORT (default 22) — set if your VPS uses a different SSH port
#
# If you see "Connection timed out": VPS may be down; firewall must allow your SSH port from
# GitHub IPs (https://api.github.com/meta) or 0.0.0.0/0 for testing.

name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -e

          # Default SSH port if not set
          SSH_PORT="${SSH_PORT:-22}"

          if [ -z "$SSH_HOST" ] || [ -z "$SSH_USER" ] || [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "::error::Missing secrets. In repo Settings → Secrets and variables → Actions, set: SSH_HOST, SSH_USER, SSH_PRIVATE_KEY"
            exit 1
          fi

          echo "Setting up SSH (host=$SSH_HOST port=$SSH_PORT)..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          if [ "$SSH_PORT" = "22" ]; then
            ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          else
            ssh-keyscan -H -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi

          # SSH options: timeout 60s, custom port, retry on drop
          SSH_OPTS="-i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=60 -o ServerAliveInterval=15 -o ServerAliveCountMax=3 -o BatchMode=yes -p $SSH_PORT"

          echo "Deploying to VPS (with retries)..."
          for attempt in 1 2 3; do
            echo "Attempt $attempt/3..."
            if ssh $SSH_OPTS "${SSH_USER}@${SSH_HOST}" "echo 'SSH OK'"; then
              break
            fi
            if [ "$attempt" -eq 3 ]; then
              echo "::error::SSH connection failed after 3 attempts."
              echo "Check: (1) VPS is running (2) Firewall allows port $SSH_PORT from GitHub IPs: https://api.github.com/meta (3) SSH_HOST/SSH_USER/SSH_PRIVATE_KEY are correct (4) If using custom port, add secret SSH_PORT"
              exit 1
            fi
            echo "Retrying in 15s..."
            sleep 15
          done

          ssh $SSH_OPTS "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e

          echo "[1/7] Go to project directory"
          cd /root/markanoLst

          echo "[2/7] Pull latest code"
          git fetch origin main
          git reset --hard origin/main

          echo "[3/7] Install dependencies"
          export NODE_ENV=production
          NPM_CONFIG_PRODUCTION=false npm install --no-audit --no-fund || { echo "ERROR: npm install failed"; exit 1; }

          echo "[4/7] Build Next.js"
          npm run build

          echo "[5/8] Prepare standalone"
          mkdir -p .next/standalone/.next
          cp -r .next/static .next/standalone/.next/ || true
          cp -r public .next/standalone/ || true
          cp .env .next/standalone/.env || true

          echo "[6/8] Run DB migration (gold_student_devices)"
          if [ -f /root/markanoLst/scripts/054-gold-student-devices.sql ]; then
            DATABASE_URL=$(grep '^DATABASE_URL=' .env 2>/dev/null | sed 's/^DATABASE_URL=//' | tr -d '\r"' | head -1)
            if [ -n "$DATABASE_URL" ]; then
              if command -v psql >/dev/null 2>&1; then
                psql "$DATABASE_URL" -f /root/markanoLst/scripts/054-gold-student-devices.sql && echo "Table gold_student_devices created/verified."
              else
                echo "psql not found; install with: apt-get install -y postgresql-client"
              fi
            else
              echo "DATABASE_URL not set in .env; skip migration"
            fi
          fi

          echo "[7/8] Restart PM2"
          chmod +x /root/markanoLst/scripts/start-standalone.sh
          if pm2 describe markano-next >/dev/null 2>&1; then
            pm2 restart markano-next
          else
            pm2 start /root/markanoLst/scripts/start-standalone.sh --name markano-next --interpreter bash
            pm2 save
          fi

          echo "[8/9] Nginx + SSL (markano.tech)"
          if [ -f /root/markanoLst/scripts/setup-ssl-markano.sh ]; then
            chmod +x /root/markanoLst/scripts/setup-ssl-markano.sh
            bash /root/markanoLst/scripts/setup-ssl-markano.sh
          fi

          echo "[8/9] Verify SSL on VPS"
          if [ -f /root/markanoLst/scripts/verify-ssl-vps.sh ]; then
            chmod +x /root/markanoLst/scripts/verify-ssl-vps.sh
            bash /root/markanoLst/scripts/verify-ssl-vps.sh || true
          fi

          echo "[9/9] Deploy finished successfully"
          EOF

      - name: Deploy success
        run: echo "Deploy to VPS completed successfully."
