# Deploy to VPS when pushing to main
# Push to https://github.com/abdirisak009/markanoLst â†’ auto-deploy to VPS
# Uses SSH key: private key in GitHub Secrets (SSH_PRIVATE_KEY), public key on server (authorized_keys)

name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set -e

          echo "Setting up SSH..."
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          echo "Deploying to VPS..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e

          echo "[1/7] Go to project directory"
          cd /root/markanoLst

          echo "[2/7] Pull latest code"
          git fetch origin main
          git reset --hard origin/main

          echo "[3/7] Install dependencies"
          export NODE_ENV=production
          NPM_CONFIG_PRODUCTION=false npm install --no-audit --no-fund || { echo "ERROR: npm install failed"; exit 1; }

          echo "[4/7] Build Next.js"
          npm run build

          echo "[5/7] Prepare standalone"
          mkdir -p .next/standalone/.next
          cp -r .next/static .next/standalone/.next/ || true
          cp -r public .next/standalone/ || true
          cp .env .next/standalone/.env || true

          echo "[6/7] Restart PM2"
          chmod +x /root/markanoLst/scripts/start-standalone.sh
          if pm2 describe markano-next >/dev/null 2>&1; then
            pm2 restart markano-next
          else
            pm2 start /root/markanoLst/scripts/start-standalone.sh --name markano-next --interpreter bash
            pm2 save
          fi

          echo "[7/7] Deploy finished successfully"
          EOF

      - name: Deploy success
        run: echo "Deploy to VPS completed successfully."
